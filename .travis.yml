---
language: generic

sudo: required

os:
  - linux
  - osx

cache:
  apt: true
  pip: true
  directories:
    - $HOME/Library/Caches/Homebrew

before_install:
  # Uninstall existing brew installation.
  - >
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      curl -sLO https://raw.githubusercontent.com/Homebrew/install/master/uninstall
      chmod +x ./uninstall
      ./uninstall --force
      sudo rm -rf /usr/local/Homebrew
      sudo rm -rf /usr/local/Caskroom
      sudo rm -rf /usr/local/bin/brew
    fi

install:
  - >
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      # See: https://stackoverflow.com/a/49748494/100134
      curl https://bootstrap.pypa.io/get-pip.py | sudo python
      sudo -H pip install ansible
    fi

script:
  - travis_wait 30 ./run

  # Idempotence Test
  # https://blog.travis-ci.com/2017-11-30-testing-ansible-roles-using-docker-on-travis
  - >
    ansible-playbook -i ./hosts site.yml
    | grep -q 'changed=0.*failed=0'
    && (echo 'Idempotence test: pass' && exit 0)
    || (echo 'Idempotence test: fail' && exit 1)

after_script:
  - ls -la ~/

notifications:
  email: false
